##########################
# Skripte
##########################

restart_hass:
  alias: Restart Home Assistant
  sequence:
    - service: script.prepare_restart
    - service: shell_command.restart_homeassistant

prepare_restart:
  alias: Prepare for restart
  sequence:
    - service: switch.turn_on
      entity_id: switch.tv 
    - service: switch.turn_on
      entity_id: switch.sonos_speaker

reload_automations:
  alias: Reload Automations
  sequence:
    - alias: Reload-Automations
      service: automation.reload

reboot_pi:
  alias: Reboot System
  sequence:
    - service: homeassistant.stop
    - service: shell_command.reboot_command_pi 

# Turns lights on and off after sunset
vacation_lights:
  alias: Vacation Light Mode
  sequence:
    # wait an hour after sunset
    - delay:
        hours: 1
    # turn lights on for 2 hours after sunset
    - service: notify.ios_iphones_app
      data:
        title: 'Vacation mode'
        message: 'I switched on the lights while you are on vacation'
    - service: light.turn_on
      entity_id: light.fernseher
    - delay:
        hours: 2
    # turn lights off
    - service: light.turn_off
      entity_id: light.fernseher

# Inspired by https://github.com/Tommatheussen/Home-Assistant-Configuration/blob/master/script/get_latest_config.yaml
get_latest_config:
  alias: 'Update config'
  sequence:
    - service: shell_command.git_pull

turn_off_livingroom_delay_15:
  alias: 'Turn off livingroom group (delay 15 minutes)'
  sequence:
    - delay:
        minutes: 15
    - service: homeassistant.turn_off
      entity_id: group.wohnzimmer
    - service: script.turn_on
      entity_id: script.christmas_lights_off

turn_off_bedroom_delay_45:
  alias: 'Turn off bedroom (delay 45 minutes)'
  sequence:
    - delay:
        minutes: 45
    - service: homeassistant.turn_off
      entity_id: group.schlafzimmer

turn_tv_on:
  sequence:
    - service: broadlink.send_packet_192_168_178_51
      data:
        packet: 
          - 'JgDSAJSUEzcSNxM3EhISExISEhMSEhI3EzcSOBISEhISExISEhITNxISEhMROBI4EhISExE4EhMROBI4EhISEhI4EjgSEhIABgCUlBI3EzcSOBISEhISExISEhISOBI3EzcSEhITEhISExISEjcTEhISEjgSNxITERMSOBISEjcSOBISExISNxI4EhISAAYAlJQSOBI3EzcSEhITEhISEhITEjcSOBI3ExISEhITERMSEhI4EhISExE4EjgSEhISEjgSEhI4EjcTEhISEjgSNxITEgANBQAAAAAAAA=='
          
turn_tv_off:
  sequence:
    - service: broadlink.send_packet_192_168_178_51
      data:
        packet: 
          - 'JgDSAJaUEzYTNxI4EhISEhMSERMRExI4EjgSNxMSEBQSEhITEBQRExITERMRNhU3EhMQFBI3EzcSOBM2EhMRExI3EjgSEhIABgCUlBI4EzYUNhITERMSEhITEBQSNxM3EjgTERISEhMRExISERQRExISEjgSOBMRERMRORI3EzcTNxETERMRORI3ExISAAYAlJQTNhI4EzYUERISEhMRExISEjgSNxM3EhISExETEhITEhETEhMRExI3EjgTERITETgSOBI3EzcSEhITETgTNxISEgANBQAAAAAAAA=='

turn_receiver_on:
  sequence:
    - service: broadlink.send_packet_192_168_178_51
      data:
        packet: 
          - 'JgBQAAABKJMUERQ1FBEVERQ1FBEUNRQ2FDUUERQ1FTUUERQ1FDYUERQRFBEUNRQSFBEUERQRFBEUNRQ2FBEUNRQ1FDYUNRQ1FQAFAgABKEgUAA0FAAAAAAAAAAA='

turn_receiver_off:
  sequence:
    - service: broadlink.send_packet_192_168_178_51
      data:
        packet: 
          - 'JgBQAAABJpQTExI3EhMVEBM2ExMSNxI3FBEVERQ1EjcTEhM3EjcTEhM2EzcSNxMSFBESFBI3EhMTEhMSExIUNhI3EzYTEhM3EgAFKAABJ0oSAA0FAAAAAAAAAAA='

input_hdmi:
  sequence:
    - service: broadlink.send_packet_192_168_178_51
      data:
        packet:
          - 'JgDSAJaSFDYSNxU1FBAUERQQFBAVEBQ1FDYUNRUQFBAUEBUQFBAUNhQQFBAVNRQQFDYUNRU1FBEROBQ2FBAUNhQQFBAVEBQABf6WkhQ1FDYUNRUQERMSEhITFBAUNhQ1FDYSEhITFBAUEBQRFDUUERQQFDUVEBQ1FTUUNhQQFDUVNRQQFTUUEBQRERMUAAX+lpIUNhQ1FDYUEBQQFRASEhQQFTUUNhE4FBEUEBISFRAUEBI4FBAUEBQ2FBAVNRQ1FTUUEBM3FDUSExI3FRAUEBQRFAANBQAAAAAAAA=='
          
input_tv:
  sequence:
    - service: script.all_media_pause 
    - service: script.turn_on
      entity_id: script.turn_receiver_on
    # switch on TV and change input
    - service: broadlink.send_packet_192_168_178_51
      data:
        packet:
          # switch on TV
          - 'JgDSAJSUEjgSNxM3EhISExISEhIRFBI3EjgSNxITERMSExETEhISOBI3ExISNxI4EhISExETERMSExI3ERQRExI4ETgSOBEABgGUlBM2EjYUNxMSERMSExISEhISOBI3EjgTERITERMSEhITETgSOBISEjgSNxITEhIRExITEhISOBISEhISOBI4EjcSAAYAlJQSOBI3EzcSEhITEBQSEhITETgSOBI3EhMRExISEhMSEhI4EzYRFBE4EjgSEhITERMSEhITETgSExETEjcSOBI4EgANBQAAAAAAAA=='
          # change receiver input to TV
          - 'JgBQAAABKJMUERQ1FREUERQ1FBEUNRQ2FDUUERU0FTUUERQ1FTUUERQ1FBEVEBU1FBEUERQRFBEVEBU1FDUUERU0FTUUNRQ1FQAFAgABKEgUAA0FAAAAAAAAAAA='

input_apple_tv:
  sequence:
    - service: script.all_media_pause
    - service: script.turn_on
      entity_id: script.turn_receiver_on
    - service: broadlink.send_packet_192_168_178_51
      data:
        packet:
          # switch receiver input to AppleTV 
          - 'JgBQAAABKJMUERQ1FBEVEBU1FBEUNRQ2FDUUERU0FDYUERQ1FTUUERQ1FDUUNhQ1FBEVEBURFBEUERQRFBEUERQ1FDYUNRQ1FQAFAgABKEgUAA0FAAAAAAAAAAA='
    # switch to input HDMI
    - service: script.turn_on
      entity_id: script.input_hdmi
    - service: script.turn_on
      entity_id: script.turn_tv_on


input_plex:
  sequence:
    - service: script.turn_on
      entity_id: script.turn_receiver_on
    - service: switch.turn_on
      entity_id: switch.server
    - service: script.turn_on
      entity_id: script.input_apple_tv

input_fire_tv:
  sequence:
    - service: script.all_media_pause
    - service: script.turn_on
      entity_id: script.turn_receiver_on
    - service: broadlink.send_packet_192_168_178_51
      data:
        packet:
          # switch receiver to input FireTV
          - 'JgBQAAABKZIUERU1FBEUERQ1FBEVNRQ1FDUUEhQ1FDUUERU1FDUUERQ2FBEUNRQ1FBIUERQRFBEUERQ1FBEVERQ1FDUUNRU1FAAFAgABKEkUAA0FAAAAAAAAAAA='
    # switch to input HDMI
    - service: script.turn_on
      entity_id: script.input_hdmi
    - service: script.turn_on
      entity_id: script.turn_tv_on

input_music:
  sequence:
    - service: script.all_media_pause
    - service: script.turn_on
      entity_id: script.turn_receiver_on
    - service: broadlink.send_packet_192_168_178_51
      data:
        packet:
          # change input to AppleTV
          - 'JgBQAAABKJMUERQ1FBEVEBU1FBEUNRQ2FDUUERU0FDYUERQ1FTUUERQ1FDUUNhQ1FBEVEBURFBEUERQRFBEUERQ1FDYUNRQ1FQAFAgABKEgUAA0FAAAAAAAAAAA='
    - service: script.turn_on
      entity_id: script.turn_tv_off

all_media_pause:
  sequence:
    - service: script.pause_sonos
    - service: media_player.turn_on
      entity_id: media_player.atv_wohnzimmer
    - service: media_player.media_stop
      entity_id: media_player.atv_wohnzimmer

pause_sonos:
  sequence:
    - service: media_player.media_pause
      entity_id: media_player.living_room

play_sonos:
  sequence:
    - service: switch.turn_on
      entity_id: switch.speaker_1
    - service: media_player.media_play
      entity_id: media_player.living_room

sonos_play_radio:
  sequence:
    - service: input_select.select_option
      data:
        entity_id: input_select.sonos_source
        option: 'HIT RADIO FFH'

sonos_welcome_message:
  sequence:
    - delay:
        seconds: 35
    - service: script.turn_on
      entity_id: script.sonos_say
      data:
        variables:
          message: "Willkommen zuhause! Schön das du wieder da bist" #Wrong grammar, but sounds nicer!

turn_off_fan_after_delay:
  sequence:
    - delay:
        hours: 2
    - service: switch.turn_off
      entity_id: switch.ventilator 

turn_off_all:
  sequence:
    - service: light.turn_off
      entity_id: group.all_lights
    - service: switch.turn_off
      entity_id: group.all_switches
    - service: input_select.select_option
      data:
        entity_id: input_select.tv_mode
        option: AUS 
    - service: input_select.select_option

turn_off_speaker_after_delay:
  sequence:
    - delay:
        minutes: 10
    - service: switch.turn_off
      entity_id: switch.sonos_speaker

livingroom_morning:
  sequence:
    - service: script.turn_on
      entity_id: script.livingroom_default_lights
    - service: script.turn_on
      entity_id: script.christmas_lights_on

livingroom_default_lights:
  sequence:
    - service: light.turn_on
      data: 
        entity_id: light.sofa
        brightness: 150
        transition: 4
    - service: light.turn_on
      data: 
        entity_id: light.fernseher
        brightness: 150
        transition: 4

livingroom_dimmed_lights:
  sequence:
    - service: light.turn_on
      data: 
        entity_id: light.wohnzimmer
        brightness: 20
        transition: 4

bedroom_dimmed_lights:
  sequence:
    - service: light.turn_on
      data: 
        entity_id: light.schlafzimmer
        brightness: 100
        transition: 4

turn_off_livingroom_lights_delay_15:
  alias: 'Turn off livingroom lights (delay 15 minutes)'
  sequence:
    - delay:
        minutes: 15
    - service: light.turn_off
      entity_id: light.wohnzimmer
    - service: script.turn_on
      entity_id: script.christmas_lights_off

christmas_lights_on:
  sequence:
    - service: switch.turn_on
      entity_id: switch.light_sterne
    - service: switch.turn_on
      entity_id: switch.baum
    - service: switch.turn_on
      entity_id: switch.socket_1

christmas_lights_off:
  sequence:
    - service: switch.turn_off
      entity_id: switch.light_sterne
    - service: switch.turn_off
      entity_id: switch.baum
    - service: switch.turn_off
      entity_id: switch.socket_1

my_weather:
  alias: My Weather
  sequence:
    - service: script.turn_on
      entity_id: script.sonos_say
      data:
        variables:
          message: "Draußen ist es 0 Grad kalt"

# Inspired by https://github.com/arsaboo/homeassistant-config/blob/master/scripts.yaml
sonos_say:
    alias: "Sonos TTS script"
    sequence:
      - service: media_player.sonos_snapshot
        data_template:
          entity_id: "{{ sonos_entity|default('media_player.living_room') }}"
      - service: media_player.sonos_unjoin
        data_template:
          entity_id: "{{ sonos_entity|default('media_player.living_room') }}"
      - service: media_player.volume_set
        data_template:
          entity_id: "{{ sonos_entity|default('media_player.living_room') }}"
          volume_level: "{{ volume|default(0.4) }}"
      - service: tts.google_say
        data_template:
          entity_id: "{{ sonos_entity|default('media_player.living_room') }}"
          message: "{{ message }}"
      - delay: "{{ delay|default('00:00:00') }}"
      - wait_template: "{{ is_state(sonos_entity|default('media_player.living_room'), 'playing') }}"
        timeout: '00:00:05'
      - wait_template: "{{ not is_state(sonos_entity|default('media_player.living_room'), 'playing') }}"
        timeout: '00:00:20'
      - service: media_player.sonos_restore
        data_template:
          entity_id: "{{ sonos_entity|default('media_player.living_room') }}"

sonos_tts:
  sequence:
    - service: media_player.sonos_snapshot
      data_template:
        entity_id: "media_player.{{ where }}"
    - service: tts.google_say
      data_template:
        entity_id: "media_player.{{ where }}"
        message: "{{ message }}"
    - delay: '00:00:{{ states.media_player[where].attributes.media_duration | int }}'
    - service: media_player.sonos_restore
      data_template:
        entity_id: "media_player.{{ where }}"
